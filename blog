#!/bin/zsh

new-post() {
	read "?Title: " title
	escaped=$(sed 's/ /-/g' <<< $title)
	postfile="drafts/$escaped.html"

	if [[ -f $postfile ]]; then
		echo "Post with this name already exists"
		exit
	fi

	cat << EOF > metadata/$title
title=$title
EOF

	touch $postfile
	edit $escaped.html
}

update() {
	ls drafts \
		| fzf \
		| read post
	edit $post
}

edit() {
	postfile=$1
	$EDITOR drafts/$postfile

	read "?Is this post ready for rendering? (y/N): " ans

	if [[ ans == [yY] ]]; then
		ln -sf drafts/$postfile published/$postfile
	fi
}

render-post() {
	echo "Started rendering $1"
	template=templates/post.template.html
	echo "Template: $template"
	content=$(cat published/$1.html)

	awk < metadata/$1 -F'=' '/title/{print $2}' | read title
	echo "Title: $title"

	# echo awk -v title=$title -v content=$content < $template '/<!-- TITLE -->/{print $title} /<!-- POST -->/{print $content} {print}'
	awk -v title=$title -v content=$content < $template '/<-- TITLE -->/{print title} /<-- POST -->/{print content} !/<--/{print}' > html/posts/$1.html
	echo "Done rendering $1"
}

render-list() {

}

render-rss() {

}

render() {
	for post in published/*.html; do
		render-post $(basename $post .html)
	done

	render-list
	render-rss

}

echo "New\nEdit\nRender" \
	| fzf \
	| read choice

case $choice in
	New)
		new-post;;
	Edit)
		update;;
	Render)
		render;;
esac
