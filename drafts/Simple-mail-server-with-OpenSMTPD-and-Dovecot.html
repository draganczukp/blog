<h2>Why not just use Gmail like a normal person?</h2>
<p>
If you ask a group of people who self host their own mail servers, most of them will tell you that it's about freedom and privacy. I did it just because I wanted to. While I'm glad that no one will be reading my mail (other than me), it wasn't my main reason. I just wanted the ability to brag to other sysadmins that I have my own mail server.
</p>
<h2>End goal</h2>
<p>
A server that can receive messages for multiple addresses and deliver them to specific users. For example mail@domain, admin@domain, postmaster@domain will go to admin's mailbox, while newsletter@domain, spam@domain will go to a different user. The messages can then be read in a mail client, like neomutt or geary.
</p>

<h2>Prerequisites</h2>
<p>
Before you get started, you will need a few things:
<ul>
	<li>A server running Linux. I'll be using a VPS from Digital Ocean running Arch</li>
	<li>A domain, with the ability to add MX and TXT records</li>
	<li>Some basic Linux knowledge, mainly editing config files and starting services</li>
</ul>
</p>
<p>
You can get a VPS from Digital Ocean for $5/month. If you use <a href="https://m.do.co/c/df8761037c40">my referral link</a> to get $100 for two months (I also get something from that). Just keep in mind that after two months you'll have to start paying normally.
</p>
<p>
If you don't have a domain already, you must purchase it from some registrar, like NameCheap. Or you can get a free .tk domain from <a href="https://dot.tk">dot.tk</a>.
</p>
<p>
I won't cover pointing the domain to your server. Most hostings have a guide explaining how to do it.
</p>
<h2>The server stack</h2>
<p>
In this guide I'll be using OpenSMTPD as my MTA and Dovecot as MDA, but we'll ignore POP3 and only use it for IMAP. If you think that's a lot of abbreviations, wait till we make sure the messages aren't spam with DKIM, DMARC and SPIF.
</p>
<h3>A small disclaimer</h3>
<p>
OpenSMTPD in the Archlinux repos is slightly outdated (version 6.0.3) and uses older config syntax. If you use a newer version and it doesn't work for you, read <a href="https://poolp.org/posts/2018-05-21/switching-to-opensmtpd-new-config/">this article</a>.
</p>
<h2>Step 1: Install all the software needed</h2>
<p>
In order to get a mail server going you need a MTA, aka the thing that receives and sends messages. We'll also need a MDA for accessing the mail from other devices. We're using OpenSMTPD and Dovecot, so install them using your distros package manager. For me it would be <pre><code>
sudo pacman -S opensmtpd dovecot
</code></pre>
Now you just need to start them to make sure they work:
<pre><code>
sudo systemctl enable --now smtpd dovecot
</code></pre>
This line will start them and make sure they also start on boot
</p>
<h2>Step 2: Configure OpenSMTPD to receive mail</h2>
<p>
The default config will let you send mail between users on the same server, which isn't very useful for us. Let's change it so that we may send and receive messages from outside.
</p>
<p>
Edit the file <code>/etc/smtpd/smtpd.conf</code>. Change the line that says <pre><code>
listen on localhost
</code></pre>
to<pre><code>
listen on all
</code></pre>
Also uncomment the line <pre><code>
#accept from any for domain "example.org" alias <aliases> deliver to mbox
</code></pre>
and change the domain from "example.org" to your domain
</p>
<p>
You should now be able to send mail to your new server with the address [username]@[domain], where username is an user that actually exists on your server. We'll later use virtual users for that, so it will look something like mail@domain.com, but for now this will do.
</p>
<p>
Once you send a mail to yourself you'll probably want to read it. Running the command <code>mail</code> on your server will open a mail program. You may need to install it first (on Arch the package is called "s-nail). If it shows errors or is empty, try running it with <code>-f</code>, so that it'll check in different locations.
</p>
<h2>Step 3: Creating tables</h2>
<p>
Tables are just text files with data, that will be read by OpenSMTPD. Each row is one entry, and columns are separated by whitespace.
</p>
<p>
You should decide now what mail addresses you want and which users should receive mail for them. I have it setup so that mail@draganczuk.tk and admin@draganczuk.tk go to a single user called "mail", but newsletter@draganczuk.tk and blackhole@draganczuk.tk go to a different user that I ignore most of the time.
</p>
<h3>Step 3.1: Creating users</h3>
<p>
You need to create each user and set their password:
<pre><code>
sudo useradd -m -s /bin/bash <user>
sudo passwd <user>
</code></pre>
</p>
<p>
Now that they exist, we need to tell OpenSMTPD to use them. First we need to hash their passwords:
<pre><code>
sudo smtpctl encrypt <password>
</code></pre>
Then we need to create a table for these users in file <code>/etc/smtpd/users</code> with this format:
<pre><code>
user1	hash1
user2	hash2
</code></pre>
</p>
<h3>Step 3.2: Creating addresses</h3>
<p>
Now that we have users, we need addresses for them. We do that with another table, this time in <code>/etc/smtpd/addresses</code> with this format:
<pre><code>
<name1>@<domain>		<user1>
<name2>@<domain>		<user2>
</code></pre>
You can also specify multiple users to receive from a specific address, or even another email address, like this:
<pre><code>
combined@<domain>		user1,user2,mail@example.com
</code></pre>
</p>
<h3>Step 3.3: Create domain list</h3>
<p>
If you're using a single server for hosting multiple domains, you will have to create a domain list. Even if you don't, it's a good idea to do so, just in case you'll need it later. The list is just a file in <code>/etc/smtpd/domains</code> with each domain in one line, like this:
<pre><code>
<domain1>
<domain2>
</code></pre>

</p>
<++>
